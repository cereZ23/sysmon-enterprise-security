<?xml version='1.0' encoding='utf-8'?>
<Sysmon schemaversion="4.50">

  <!-- ================================================================
       SYSMON CONFIGURATION FOR SQL SERVER
       ================================================================
       Target: SQL Server 2016/2019/2022
       Focus: SQL injection, xp_cmdshell abuse, credential theft, data exfil
       Noise Level: High (SQL engine is very active)
       Key Exclusions: sqlservr.exe, SQLAGENT.EXE, backup operations
       ================================================================ -->

  <HashAlgorithms>sha256</HashAlgorithms>
  <EventFiltering>

    <!-- ============================================
         EVENT ID 1: PROCESS CREATE
         SQL SERVER: Refactored with AND rules for precision
         ============================================ -->
    <RuleGroup name="ProcessCreate" groupRelation="or">
      <ProcessCreate onmatch="include">
        <!-- ===== CRITICAL: xp_cmdshell detection (AND rules) ===== -->
        <!-- SQL Server spawning shells = xp_cmdshell abuse -->
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">cmd.exe</Image>
        </Rule>
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">powershell.exe</Image>
        </Rule>
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">pwsh.exe</Image>
        </Rule>

        <!-- SQL Agent spawning shells = Agent Job abuse -->
        <Rule groupRelation="and">
          <ParentImage condition="end with">\SQLAGENT.EXE</ParentImage>
          <Image condition="image">cmd.exe</Image>
        </Rule>
        <Rule groupRelation="and">
          <ParentImage condition="end with">\SQLAGENT.EXE</ParentImage>
          <Image condition="image">powershell.exe</Image>
        </Rule>

        <!-- SQL spawning discovery tools -->
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">whoami.exe</Image>
        </Rule>
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">net.exe</Image>
        </Rule>
        <Rule groupRelation="and">
          <ParentImage condition="end with">\sqlservr.exe</ParentImage>
          <Image condition="image">hostname.exe</Image>
        </Rule>

        <!-- ===== Processes from suspicious locations ===== -->
        <Image condition="begin with">C:\Users\</Image>
        <Image condition="begin with">C:\Windows\Temp\</Image>
        <Image condition="begin with">C:\Temp\</Image>

        <!-- ===== SQL-specific attack commands (always monitor) ===== -->
        <CommandLine condition="contains">xp_cmdshell</CommandLine>
        <CommandLine condition="contains">sp_configure</CommandLine>
        <CommandLine condition="contains">OPENROWSET</CommandLine>
        <CommandLine condition="contains">OPENDATASOURCE</CommandLine>
        <CommandLine condition="contains">xp_regread</CommandLine>
        <CommandLine condition="contains">xp_regwrite</CommandLine>
        <CommandLine condition="contains">xp_dirtree</CommandLine>
        <CommandLine condition="contains">xp_fileexist</CommandLine>
        <CommandLine condition="contains">xp_subdirs</CommandLine>

        <!-- PowerShell download cradles (always suspicious on server) -->
        <CommandLine condition="contains">Invoke-</CommandLine>
        <CommandLine condition="contains">-enc</CommandLine>
        <CommandLine condition="contains">-encodedcommand</CommandLine>
        <CommandLine condition="contains">downloadstring</CommandLine>
        <CommandLine condition="contains">IEX</CommandLine>
        <CommandLine condition="contains">Net.WebClient</CommandLine>

        <!-- Credential Access (always monitor) -->
        <Image condition="image">vssadmin.exe</Image>
        <Image condition="image">procdump.exe</Image>
        <Image condition="image">procdump64.exe</Image>
        <CommandLine condition="contains">comsvcs.dll</CommandLine>
        <CommandLine condition="contains">MiniDump</CommandLine>

        <!-- LOLBins (always suspicious on SQL server) -->
        <Image condition="image">certutil.exe</Image>
        <Image condition="image">mshta.exe</Image>
        <Image condition="image">regsvr32.exe</Image>
        <Image condition="image">msbuild.exe</Image>
        <Image condition="image">wscript.exe</Image>
        <Image condition="image">cscript.exe</Image>

        <!-- T1110 - Brute Force Detection -->
        <Image condition="image">hydra.exe</Image>
        <Image condition="image">medusa.exe</Image>
        <Image condition="image">ncrack.exe</Image>
        <CommandLine condition="contains">-P password</CommandLine>
        <CommandLine condition="contains">--passwords</CommandLine>

        <!-- T1078 - Valid Accounts Detection -->
        <Image condition="image">runas.exe</Image>
        <Image condition="image">cmdkey.exe</Image>
        <CommandLine condition="contains">/user:</CommandLine>
        <CommandLine condition="contains">/savecred</CommandLine>
        <CommandLine condition="contains">-Credential</CommandLine>

        <!-- T1098 - Account Manipulation Detection -->
        <CommandLine condition="contains">net user /add</CommandLine>
        <CommandLine condition="contains">net localgroup /add</CommandLine>
        <CommandLine condition="contains">Add-LocalGroupMember</CommandLine>
        <CommandLine condition="contains">New-LocalUser</CommandLine>

        <!-- T1558 - Steal or Forge Kerberos Tickets -->
        <Image condition="image">klist.exe</Image>
        <Image condition="image">rubeus.exe</Image>
        <CommandLine condition="contains">kerberos::</CommandLine>
        <CommandLine condition="contains">asreproast</CommandLine>
        <CommandLine condition="contains">kerberoast</CommandLine>
        <CommandLine condition="contains">golden</CommandLine>
        <CommandLine condition="contains">silver</CommandLine>
        <CommandLine condition="contains">Invoke-Kerberoast</CommandLine>

        <!-- Discovery commands (unusual on SQL server) -->
        <Image condition="image">whoami.exe</Image>
        <Image condition="image">hostname.exe</Image>
        <Image condition="image">net.exe</Image>
        <Image condition="image">net1.exe</Image>
        <Image condition="image">systeminfo.exe</Image>
        <Image condition="image">tasklist.exe</Image>
        <Image condition="image">query.exe</Image>
        <Image condition="image">ipconfig.exe</Image>
        <Image condition="image">netstat.exe</Image>
        <!-- T1087.001 specific - Local Account Discovery -->
        <CommandLine condition="contains">net user</CommandLine>
        <CommandLine condition="contains">net1 user</CommandLine>
        <CommandLine condition="contains">get-localuser</CommandLine>
        <CommandLine condition="contains">wmic useraccount</CommandLine>

        <!-- Lateral Movement -->
        <Image condition="image">psexec.exe</Image>
        <Image condition="image">psexesvc.exe</Image>

        <!-- Service/Task manipulation -->
        <Image condition="image">schtasks.exe</Image>
        <Image condition="image">sc.exe</Image>

        <!-- Data exfiltration indicators -->
        <Image condition="image">rar.exe</Image>
        <Image condition="image">7z.exe</Image>
        <Image condition="image">7za.exe</Image>
      </ProcessCreate>
    </RuleGroup>

    <!-- ProcessCreate Exclusions - SQL SERVER -->
    <RuleGroup name="ProcessCreate_Exclude" groupRelation="or">
      <ProcessCreate onmatch="exclude">
        <!-- SQL Server internal processes - EXACT PATHS -->
        <!-- Customize version number for your environment -->
        <Image condition="begin with">C:\Program Files\Microsoft SQL Server\MSSQL</Image>
        <Image condition="end with">\sqlservr.exe</Image>
        <Image condition="end with">\SQLAGENT.EXE</Image>
        <Image condition="end with">\fdhost.exe</Image>
        <Image condition="end with">\fdlauncher.exe</Image>
        <Image condition="end with">\sqlceip.exe</Image>
        <Image condition="end with">\sqlwriter.exe</Image>

        <!-- SSMS (only from Program Files) -->
        <Image condition="is">C:\Program Files (x86)\Microsoft SQL Server Management Studio 18\Common7\IDE\Ssms.exe</Image>
        <Image condition="is">C:\Program Files (x86)\Microsoft SQL Server Management Studio 19\Common7\IDE\Ssms.exe</Image>

        <!-- Splunk Forwarder -->
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
        <ParentImage condition="is">C:\Program Files\SplunkUniversalForwarder\bin\splunkd.exe</ParentImage>

        <!-- Backup software - CUSTOMIZE FOR YOUR ENVIRONMENT -->
        <!-- <ParentImage condition="begin with">C:\Program Files\Veeam\</ParentImage> -->
        <!-- <ParentImage condition="begin with">C:\Program Files\Commvault\</ParentImage> -->
      </ProcessCreate>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 13: REGISTRY EVENT
         Expanded coverage for persistence and tampering
         ============================================ -->
    <RuleGroup name="RegistryEvent" groupRelation="or">
      <RegistryEvent onmatch="include">
        <!-- ===== PERSISTENCE MECHANISMS ===== -->
        <!-- T1547.001 - Run Keys -->
        <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunOnceEx</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunServices</TargetObject>

        <!-- T1547.004 - Winlogon -->
        <TargetObject condition="contains">CurrentVersion\Winlogon\Shell</TargetObject>
        <TargetObject condition="contains">CurrentVersion\Winlogon\Userinit</TargetObject>
        <TargetObject condition="contains">CurrentVersion\Winlogon\Notify</TargetObject>

        <!-- T1543.003 - Services -->
        <TargetObject condition="end with">\ServiceDll</TargetObject>
        <TargetObject condition="end with">\ImagePath</TargetObject>
        <TargetObject condition="end with">\FailureCommand</TargetObject>
        <TargetObject condition="contains">\Parameters\ServiceDll</TargetObject>

        <!-- T1546.015 - COM Hijacking -->
        <TargetObject condition="contains">\Software\Classes\CLSID\</TargetObject>
        <TargetObject condition="contains">\InprocServer32</TargetObject>
        <TargetObject condition="contains">\LocalServer32</TargetObject>

        <!-- T1546.010 - AppInit DLLs -->
        <TargetObject condition="contains">\Windows\CurrentVersion\Windows\AppInit_DLLs</TargetObject>
        <TargetObject condition="contains">\Windows\CurrentVersion\Windows\LoadAppInit_DLLs</TargetObject>

        <!-- T1546.011 - AppCompat Shim -->
        <TargetObject condition="contains">\AppCompatFlags\Custom</TargetObject>
        <TargetObject condition="contains">\AppCompatFlags\InstalledSDB</TargetObject>

        <!-- T1546.012 - IFEO Debugging -->
        <TargetObject condition="contains">\Image File Execution Options\</TargetObject>

        <!-- ===== SQL-SPECIFIC ===== -->
        <TargetObject condition="contains">Microsoft\Microsoft SQL Server\</TargetObject>
        <TargetObject condition="contains">Microsoft\MSSQLServer\</TargetObject>

        <!-- SQL Network Configuration (tampering enables remote access) -->
        <TargetObject condition="contains">\SuperSocketNetLib\</TargetObject>
        <TargetObject condition="contains">\MSSQLServer\SuperSocketNetLib\Tcp</TargetObject>
        <TargetObject condition="end with">\Enabled</TargetObject>
        <TargetObject condition="end with">\TcpPort</TargetObject>
        <TargetObject condition="end with">\TcpDynamicPorts</TargetObject>

        <!-- SQL Security settings -->
        <TargetObject condition="contains">\MSSQLServer\LoginMode</TargetObject>
        <TargetObject condition="contains">\MSSQLServer\xp_cmdshell</TargetObject>
        <TargetObject condition="contains">\MSSQLServer\Ole Automation Procedures</TargetObject>
        <TargetObject condition="contains">\MSSQLServer\Ad Hoc Distributed Queries</TargetObject>

        <!-- ===== SECURITY TAMPERING ===== -->
        <!-- Defender -->
        <TargetObject condition="end with">\DisableAntiSpyware</TargetObject>
        <TargetObject condition="end with">\DisableAntiVirus</TargetObject>
        <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows Defender\Exclusions</TargetObject>
        <TargetObject condition="end with">\DisableRealtimeMonitoring</TargetObject>

        <!-- LSA Protection -->
        <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Lsa\</TargetObject>
        <TargetObject condition="contains">\SecurityProviders\SecurityProviders</TargetObject>
        <TargetObject condition="end with">\Security Packages</TargetObject>
        <TargetObject condition="end with">\Authentication Packages</TargetObject>

        <!-- Firewall -->
        <TargetObject condition="contains">FirewallPolicy\</TargetObject>
        <TargetObject condition="end with">\EnableFirewall</TargetObject>

        <!-- Event Log tampering -->
        <TargetObject condition="contains">\EventLog\</TargetObject>
        <TargetObject condition="end with">\MaxSize</TargetObject>
        <TargetObject condition="end with">\Retention</TargetObject>

        <!-- ===== NETWORKING ===== -->
        <TargetObject condition="contains">\Winsock\</TargetObject>
        <TargetObject condition="contains">\Internet Settings\ProxyServer</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 3: NETWORK CONNECTION
         SQL SERVER: Monitor unusual outbound connections
         ============================================ -->
    <RuleGroup name="NetworkConnect" groupRelation="or">
      <NetworkConnect onmatch="include">
        <!-- User profile connections (should be rare) -->
        <Image condition="begin with">C:\Users\</Image>

        <!-- SQL Server making connections outside normal ports -->
        <Image condition="end with">\sqlservr.exe</Image>

        <!-- Suspicious locations -->
        <Image condition="begin with">C:\Windows\Temp\</Image>
        <Image condition="begin with">C:\Temp\</Image>
        <Image condition="begin with">C:\ProgramData\</Image>

        <!-- LOLBins -->
        <Image condition="image">cmd.exe</Image>
        <Image condition="image">powershell.exe</Image>
        <Image condition="image">certutil.exe</Image>
        <Image condition="image">mshta.exe</Image>
        <Image condition="image">bitsadmin.exe</Image>

        <!-- SQL utilities (may indicate linked server abuse) -->
        <Image condition="image">sqlcmd.exe</Image>
        <Image condition="image">osql.exe</Image>

        <!-- BCP for data exfil -->
        <Image condition="image">bcp.exe</Image>

        <!-- T1021.002 - SMB/Windows Admin Shares (Lateral Movement) -->
        <DestinationPort condition="is">445</DestinationPort>
        <DestinationPort condition="is">139</DestinationPort>

        <!-- Suspicious ports -->
        <DestinationPort condition="is">4444</DestinationPort>
        <DestinationPort condition="is">5555</DestinationPort>
        <DestinationPort condition="is">6666</DestinationPort>
        <DestinationPort condition="is">31337</DestinationPort>
        <DestinationPort condition="is">9001</DestinationPort>
        <DestinationPort condition="is">9030</DestinationPort>

        <!-- FTP (data exfil) -->
        <DestinationPort condition="is">21</DestinationPort>

        <!-- Non-standard SQL ports -->
        <DestinationPort condition="is">1434</DestinationPort>
      </NetworkConnect>
    </RuleGroup>

    <RuleGroup name="NetworkConnect_Exclude" groupRelation="or">
      <NetworkConnect onmatch="exclude">
        <!-- SQL Server normal ports - within datacenter only -->
        <!-- Consider IP-based exclusions for your environment -->
        <DestinationPort condition="is">1433</DestinationPort>

        <!-- Windows Defender -->
        <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\Platform\</Image>

        <!-- Windows Update -->
        <DestinationHostname condition="end with">.windowsupdate.com</DestinationHostname>
      </NetworkConnect>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 11: FILE CREATE
         SQL SERVER: Focused on suspicious paths to reduce patching noise
         ============================================ -->
    <RuleGroup name="FileCreate" groupRelation="or">
      <FileCreate onmatch="include">
        <!-- ===== EXECUTABLES ONLY IN SUSPICIOUS PATHS (AND rules) ===== -->
        <!-- Reduces patching noise while catching staged malware -->

        <!-- exe/dll in user profiles -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.exe</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.dll</TargetFilename>
        </Rule>

        <!-- exe/dll in temp directories -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
          <TargetFilename condition="end with">.exe</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
          <TargetFilename condition="end with">.dll</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
          <TargetFilename condition="end with">.exe</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
          <TargetFilename condition="end with">.dll</TargetFilename>
        </Rule>

        <!-- exe/dll in ProgramData (staging location) -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\ProgramData\</TargetFilename>
          <TargetFilename condition="end with">.exe</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\ProgramData\</TargetFilename>
          <TargetFilename condition="end with">.dll</TargetFilename>
        </Rule>

        <!-- ===== SCRIPTS IN SUSPICIOUS PATHS ===== -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.ps1</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.bat</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.vbs</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
          <TargetFilename condition="end with">.ps1</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
          <TargetFilename condition="end with">.bat</TargetFilename>
        </Rule>

        <!-- ===== SYSTEM DIRECTORIES (always suspicious) ===== -->
        <TargetFilename condition="begin with">C:\Windows\system32\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Tasks\</TargetFilename>

        <!-- ===== SQL-SPECIFIC: Backup/DB files in SUSPICIOUS locations ===== -->
        <!-- Normal backup location excluded below, unusual = exfil attempt -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.bak</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Temp\</TargetFilename>
          <TargetFilename condition="end with">.bak</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
          <TargetFilename condition="end with">.bak</TargetFilename>
        </Rule>

        <!-- MDF/LDF outside data directories = suspicious -->
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.mdf</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
          <TargetFilename condition="end with">.ldf</TargetFilename>
        </Rule>
      </FileCreate>
    </RuleGroup>

    <RuleGroup name="FileCreate_Exclude" groupRelation="or">
      <FileCreate onmatch="exclude">
        <!-- SQL Server data directories - CUSTOMIZE FOR YOUR ENVIRONMENT -->
        <TargetFilename condition="begin with">C:\Program Files\Microsoft SQL Server\MSSQL</TargetFilename>

        <!-- Normal backup location - CUSTOMIZE -->
        <!-- <TargetFilename condition="begin with">D:\SQLBackups\</TargetFilename> -->
        <!-- <TargetFilename condition="begin with">E:\Backups\</TargetFilename> -->

        <!-- Transaction logs -->
        <TargetFilename condition="end with">.trn</TargetFilename>

        <!-- SQL internal temp -->
        <Image condition="end with">\sqlservr.exe</Image>

        <!-- Patching processes (reduce noise during updates) -->
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>
        <Image condition="is">C:\Windows\System32\wuauclt.exe</Image>
        <TargetFilename condition="contains">\WinSxS\</TargetFilename>
        <TargetFilename condition="contains">\SoftwareDistribution\</TargetFilename>
      </FileCreate>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 8: CREATE REMOTE THREAD
         Expanded AV/EDR exclusions to reduce false positives
         ============================================ -->
    <RuleGroup name="CreateRemoteThread" groupRelation="or">
      <CreateRemoteThread onmatch="exclude">
        <!-- System processes -->
        <SourceImage condition="is">C:\Windows\system32\wbem\WmiPrvSE.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\svchost.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\csrss.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\lsass.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\services.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\wininit.exe</SourceImage>

        <!-- SQL Server internal thread operations -->
        <SourceImage condition="end with">\sqlservr.exe</SourceImage>

        <!-- Windows Defender -->
        <SourceImage condition="begin with">C:\ProgramData\Microsoft\Windows Defender\Platform\</SourceImage>
        <SourceImage condition="begin with">C:\Program Files\Windows Defender\</SourceImage>
        <SourceImage condition="end with">\MsMpEng.exe</SourceImage>

        <!-- CrowdStrike Falcon -->
        <SourceImage condition="begin with">C:\Program Files\CrowdStrike\</SourceImage>
        <SourceImage condition="end with">\CSFalconService.exe</SourceImage>

        <!-- Carbon Black -->
        <SourceImage condition="begin with">C:\Program Files\Carbon Black\</SourceImage>
        <SourceImage condition="begin with">C:\Program Files (x86)\Carbon Black\</SourceImage>

        <!-- SentinelOne -->
        <SourceImage condition="begin with">C:\Program Files\SentinelOne\</SourceImage>

        <!-- Symantec/Broadcom -->
        <SourceImage condition="begin with">C:\Program Files\Symantec\</SourceImage>
        <SourceImage condition="begin with">C:\Program Files (x86)\Symantec\</SourceImage>

        <!-- Microsoft Monitoring Agent -->
        <SourceImage condition="begin with">C:\Program Files\Microsoft Monitoring Agent\</SourceImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 22: DNS QUERY
         SQL SERVER: Include-based for suspicious processes only
         Reduces noise from svchost/sqlservr while catching LOLBins
         ============================================ -->
    <RuleGroup name="DnsQuery" groupRelation="or">
      <DnsQuery onmatch="include">
        <!-- LOLBins making DNS queries = suspicious -->
        <Image condition="image">powershell.exe</Image>
        <Image condition="image">pwsh.exe</Image>
        <Image condition="image">cmd.exe</Image>
        <Image condition="image">mshta.exe</Image>
        <Image condition="image">wscript.exe</Image>
        <Image condition="image">cscript.exe</Image>
        <Image condition="image">rundll32.exe</Image>
        <Image condition="image">regsvr32.exe</Image>
        <Image condition="image">certutil.exe</Image>
        <Image condition="image">bitsadmin.exe</Image>

        <!-- SQL utilities making external queries -->
        <Image condition="image">bcp.exe</Image>
        <Image condition="image">sqlcmd.exe</Image>
        <Image condition="image">osql.exe</Image>

        <!-- Processes from suspicious locations -->
        <Image condition="begin with">C:\Users\</Image>
        <Image condition="begin with">C:\Windows\Temp\</Image>
        <Image condition="begin with">C:\Temp\</Image>
      </DnsQuery>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 19, 20, 21: WMI EVENT SUBSCRIPTION
         ============================================ -->
    <RuleGroup name="WmiEvent" groupRelation="or">
      <WmiEvent onmatch="include">
        <Operation condition="is">Created</Operation>
        <Operation condition="is">Modified</Operation>
        <Operation condition="is">Deleted</Operation>
      </WmiEvent>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 7: IMAGE LOAD (DLL)
         SQL SERVER: Monitor for injection
         ============================================ -->
    <RuleGroup name="ImageLoad" groupRelation="or">
      <ImageLoad onmatch="include">
        <!-- DLLs loaded by SQL Server from unusual locations -->
        <Rule groupRelation="and">
          <Image condition="end with">\sqlservr.exe</Image>
          <ImageLoaded condition="begin with">C:\Users\</ImageLoaded>
        </Rule>
        <Rule groupRelation="and">
          <Image condition="end with">\sqlservr.exe</Image>
          <ImageLoaded condition="begin with">C:\Temp\</ImageLoaded>
        </Rule>
        <Rule groupRelation="and">
          <Image condition="end with">\sqlservr.exe</Image>
          <ImageLoaded condition="begin with">C:\Windows\Temp\</ImageLoaded>
        </Rule>

        <!-- Credential DLLs -->
        <ImageLoaded condition="end with">\samlib.dll</ImageLoaded>
        <ImageLoaded condition="end with">\vaultcli.dll</ImageLoaded>
        <ImageLoaded condition="end with">\comsvcs.dll</ImageLoaded>
        <ImageLoaded condition="end with">\dbghelp.dll</ImageLoaded>

        <!-- PowerShell DLLs in non-PowerShell processes -->
        <ImageLoaded condition="end with">\System.Management.Automation.dll</ImageLoaded>
      </ImageLoad>
    </RuleGroup>

    <RuleGroup name="ImageLoad_Exclude" groupRelation="or">
      <ImageLoad onmatch="exclude">
        <Image condition="is">C:\Windows\System32\lsass.exe</Image>
        <Image condition="is">C:\Windows\System32\svchost.exe</Image>
        <Image condition="is">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</Image>

        <!-- SQL Server normal DLL loading from install dir -->
        <ImageLoaded condition="begin with">C:\Program Files\Microsoft SQL Server\</ImageLoaded>
      </ImageLoad>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 17, 18: PIPE CREATED/CONNECTED
         SQL SERVER: Important for linked server attacks
         ============================================ -->
    <RuleGroup name="PipeEvent" groupRelation="or">
      <PipeEvent onmatch="include">
        <!-- Attack frameworks -->
        <PipeName condition="begin with">\msagent_</PipeName>
        <PipeName condition="begin with">\MSSE-</PipeName>
        <PipeName condition="begin with">\postex_</PipeName>
        <PipeName condition="begin with">\meterpreter</PipeName>
        <PipeName condition="begin with">\psexec</PipeName>
        <PipeName condition="is">\PSEXESVC</PipeName>
        <PipeName condition="contains">mimikatz</PipeName>

        <!-- SQL Server pipe access -->
        <PipeName condition="contains">\sql\query</PipeName>
      </PipeEvent>
    </RuleGroup>

    <RuleGroup name="PipeEvent_Exclude" groupRelation="or">
      <PipeEvent onmatch="exclude">
        <PipeName condition="is">\lsass</PipeName>
        <PipeName condition="is">\netlogon</PipeName>
        <PipeName condition="is">\samr</PipeName>
      </PipeEvent>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 5: PROCESS TERMINATED
         ============================================ -->
    <RuleGroup name="ProcessTerminate" groupRelation="or">
      <ProcessTerminate onmatch="include">
        <!-- Security tools -->
        <Image condition="end with">\MsMpEng.exe</Image>
        <Image condition="contains">CrowdStrike</Image>
        <Image condition="contains">Carbon Black</Image>

        <!-- SQL Server unexpected termination -->
        <Image condition="end with">\sqlservr.exe</Image>
        <Image condition="end with">\SQLAGENT.EXE</Image>
      </ProcessTerminate>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 10: PROCESS ACCESS
         Expanded LSASS masks for credential theft detection
         ============================================ -->
    <RuleGroup name="ProcessAccess" groupRelation="or">
      <ProcessAccess onmatch="include">
        <CallTrace condition="begin with">UNKNOWN</CallTrace>
        <!-- LSASS access - expanded masks for comprehensive detection -->
        <!-- 0x40 = VM_READ, 0x1000 = VM_WRITE, 0x1010 = READ+WRITE -->
        <!-- 0x1038 = READ+WRITE+EXECUTE, 0x1410 = READ+QUERY, 0x1438 = FULL -->
        <!-- 0x143a = FULL_CONTROL, 0x1fffff = ALL_ACCESS -->
        <Rule groupRelation="and">
          <TargetImage condition="end with">lsass.exe</TargetImage>
          <GrantedAccess condition="contains any">0x40;0x1000;0x1010;0x1038;0x1410;0x1438;0x143a;0x1fffff</GrantedAccess>
        </Rule>
        <!-- SQL Server process access (injection attempts) -->
        <Rule groupRelation="and">
          <TargetImage condition="end with">\sqlservr.exe</TargetImage>
          <GrantedAccess condition="contains any">0x1fffff</GrantedAccess>
        </Rule>
      </ProcessAccess>
    </RuleGroup>

    <RuleGroup name="ProcessAccess_Exclude" groupRelation="or">
      <ProcessAccess onmatch="exclude">
        <!-- Legitimate system processes -->
        <SourceImage condition="is">C:\Windows\system32\wbem\wmiprvse.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\svchost.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\csrss.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\lsass.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\services.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\wininit.exe</SourceImage>

        <!-- Windows Defender -->
        <SourceImage condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</SourceImage>
        <SourceImage condition="begin with">C:\Program Files\Windows Defender\</SourceImage>
      </ProcessAccess>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 2: FILE CREATION TIME CHANGED
         ============================================ -->
    <RuleGroup name="FileCreateTime" groupRelation="or">
      <FileCreateTime onmatch="include">
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\</TargetFilename>
      </FileCreateTime>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 15: FILE CREATE STREAM HASH
         Detects Alternate Data Streams (ADS) - T1564.004
         ============================================ -->
    <RuleGroup name="FileCreateStreamHash" groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <!-- ALL ADS creation is suspicious on servers -->
        <TargetFilename condition="contains">:</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <RuleGroup name="FileCreateStreamHash_Exclude" groupRelation="or">
      <FileCreateStreamHash onmatch="exclude">
        <!-- Zone.Identifier is normal from downloads -->
        <TargetFilename condition="end with">:Zone.Identifier</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 6: DRIVER LOAD
         Detects unsigned/suspicious kernel drivers - T1543.003, T1014
         SQL SERVER: Important for rootkit detection
         ============================================ -->
    <RuleGroup name="DriverLoad" groupRelation="or">
      <DriverLoad onmatch="include">
        <!-- Unsigned drivers = suspicious -->
        <Signed condition="is">false</Signed>

        <!-- Drivers from suspicious locations -->
        <ImageLoaded condition="begin with">C:\Users\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Windows\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\ProgramData\</ImageLoaded>

        <!-- Known vulnerable drivers (BYOVD attacks) -->
        <ImageLoaded condition="end with">\gdrv.sys</ImageLoaded>
        <ImageLoaded condition="end with">\dbutil_2_3.sys</ImageLoaded>
        <ImageLoaded condition="end with">\RTCore64.sys</ImageLoaded>
        <ImageLoaded condition="end with">\RTCore32.sys</ImageLoaded>
        <ImageLoaded condition="end with">\PROCEXP152.SYS</ImageLoaded>
      </DriverLoad>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 9: RAW ACCESS READ
         Detects raw disk access - T1006
         SQL SERVER: Critical for offline data theft (VSS abuse)
         ============================================ -->
    <RuleGroup name="RawAccessRead" groupRelation="or">
      <RawAccessRead onmatch="include">
        <!-- Raw disk access on SQL Server = highly suspicious -->
        <!-- Used for: offline NTDS.dit extraction, backup file theft -->
        <Device condition="begin with">\Device\HarddiskVolume</Device>
      </RawAccessRead>
    </RuleGroup>

    <RuleGroup name="RawAccessRead_Exclude" groupRelation="or">
      <RawAccessRead onmatch="exclude">
        <!-- Backup software - CUSTOMIZE FOR YOUR ENVIRONMENT -->
        <!-- <Image condition="begin with">C:\Program Files\Veeam\</Image> -->
        <!-- <Image condition="begin with">C:\Program Files\Commvault\</Image> -->

        <!-- Windows Defender -->
        <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</Image>

        <!-- Volume Shadow Copy Service -->
        <Image condition="is">C:\Windows\System32\vssvc.exe</Image>
      </RawAccessRead>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 25: PROCESS TAMPERING
         Detects process hollowing, herpaderping - T1055.012
         ============================================ -->
    <RuleGroup name="ProcessTampering" groupRelation="or">
      <ProcessTampering onmatch="include">
        <!-- All process tampering types are suspicious -->
        <Type condition="contains">Image</Type>
      </ProcessTampering>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 26: FILE DELETE DETECTED
         Detects anti-forensics and evidence deletion - T1070.004
         ============================================ -->
    <RuleGroup name="FileDelete" groupRelation="or">
      <FileDelete onmatch="include">
        <!-- Executables deleted (covering tracks) -->
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>

        <!-- Scripts deleted (covering tracks) -->
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.bat</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>

        <!-- SQL backup files deleted (covering exfil tracks) -->
        <TargetFilename condition="end with">.bak</TargetFilename>

        <!-- Deletions in suspicious locations -->
        <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
        <TargetFilename condition="begin with">C:\Temp\</TargetFilename>

        <!-- Log file deletion (anti-forensics) -->
        <TargetFilename condition="end with">.log</TargetFilename>
        <TargetFilename condition="end with">.evtx</TargetFilename>
      </FileDelete>
    </RuleGroup>

    <RuleGroup name="FileDelete_Exclude" groupRelation="or">
      <FileDelete onmatch="exclude">
        <!-- Windows cleanup -->
        <Image condition="is">C:\Windows\System32\cleanmgr.exe</Image>
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>

        <!-- SQL Server log rotation -->
        <TargetFilename condition="begin with">C:\Program Files\Microsoft SQL Server\MSSQL</TargetFilename>
      </FileDelete>
    </RuleGroup>

  </EventFiltering>
</Sysmon>

<?xml version='1.0' encoding='utf-8'?>
<Sysmon schemaversion="4.50">

  <!-- ================================================================
       SYSMON CONFIGURATION FOR DOMAIN CONTROLLER
       ================================================================
       Target: Windows Server DC (2016/2019/2022)
       Focus: DCSync, Golden Ticket, Kerberoasting, AD recon
       CRITICAL: ntdsutil, mimikatz, secretsdump indicators
       ================================================================ -->

  <HashAlgorithms>sha256</HashAlgorithms>
  <EventFiltering>

    <!-- EVENT ID 1: PROCESS CREATE -->
    <RuleGroup name="ProcessCreate" groupRelation="or">
      <ProcessCreate onmatch="include">
        <!-- PowerShell/CMD -->
        <Image condition="image">powershell.exe</Image>
        <Image condition="image">pwsh.exe</Image>
        <Image condition="image">cmd.exe</Image>
        <CommandLine condition="contains">-enc</CommandLine>
        <CommandLine condition="contains">Invoke-</CommandLine>
        <CommandLine condition="contains">downloadstring</CommandLine>

        <!-- CRITICAL: AD attack tools -->
        <Image condition="image">ntdsutil.exe</Image>
        <Image condition="image">mimikatz.exe</Image>
        <CommandLine condition="contains">sekurlsa</CommandLine>
        <CommandLine condition="contains">lsadump</CommandLine>
        <CommandLine condition="contains">dcsync</CommandLine>
        <CommandLine condition="contains">kerberos::</CommandLine>
        <CommandLine condition="contains">privilege::debug</CommandLine>

        <!-- Credential dumping -->
        <Image condition="image">vssadmin.exe</Image>
        <Image condition="image">procdump.exe</Image>
        <CommandLine condition="contains">comsvcs.dll</CommandLine>
        <CommandLine condition="contains">MiniDump</CommandLine>
        <CommandLine condition="contains">ntds.dit</CommandLine>
        <CommandLine condition="contains">SYSTEM.hiv</CommandLine>

        <!-- AD Recon -->
        <Image condition="image">ldifde.exe</Image>
        <Image condition="image">csvde.exe</Image>
        <Image condition="image">dsquery.exe</Image>
        <Image condition="image">dsget.exe</Image>
        <Image condition="image">nltest.exe</Image>
        <Image condition="image">setspn.exe</Image>
        <Image condition="image">adfind.exe</Image>

        <!-- Discovery - ALL on DC -->
        <Image condition="image">whoami.exe</Image>
        <Image condition="image">net.exe</Image>
        <Image condition="image">net1.exe</Image>
        <Image condition="image">systeminfo.exe</Image>
        <Image condition="image">tasklist.exe</Image>
        <Image condition="image">ipconfig.exe</Image>
        <Image condition="image">netstat.exe</Image>
        <Image condition="image">hostname.exe</Image>
        <Image condition="image">ping.exe</Image>
        <Image condition="image">nslookup.exe</Image>

        <!-- T1110 - Brute Force Detection -->
        <Image condition="image">hydra.exe</Image>
        <Image condition="image">medusa.exe</Image>
        <Image condition="image">ncrack.exe</Image>
        <Image condition="image">crowbar.exe</Image>
        <CommandLine condition="contains">-P password</CommandLine>
        <CommandLine condition="contains">--passwords</CommandLine>

        <!-- T1078 - Valid Accounts Detection -->
        <Image condition="image">runas.exe</Image>
        <Image condition="image">cmdkey.exe</Image>
        <CommandLine condition="contains">/user:</CommandLine>
        <CommandLine condition="contains">/savecred</CommandLine>
        <CommandLine condition="contains">-Credential</CommandLine>
        <CommandLine condition="contains">Get-Credential</CommandLine>

        <!-- T1098 - Account Manipulation Detection -->
        <CommandLine condition="contains">net user /add</CommandLine>
        <CommandLine condition="contains">net localgroup /add</CommandLine>
        <CommandLine condition="contains">net group /add</CommandLine>
        <CommandLine condition="contains">Add-LocalGroupMember</CommandLine>
        <CommandLine condition="contains">Add-ADGroupMember</CommandLine>
        <CommandLine condition="contains">Set-ADUser</CommandLine>
        <CommandLine condition="contains">Set-ADAccountPassword</CommandLine>
        <CommandLine condition="contains">New-LocalUser</CommandLine>
        <CommandLine condition="contains">New-ADUser</CommandLine>

        <!-- T1558 - Steal or Forge Kerberos Tickets (CRITICAL on DC) -->
        <Image condition="image">klist.exe</Image>
        <Image condition="image">rubeus.exe</Image>
        <CommandLine condition="contains">asreproast</CommandLine>
        <CommandLine condition="contains">kerberoast</CommandLine>
        <CommandLine condition="contains">golden</CommandLine>
        <CommandLine condition="contains">silver</CommandLine>
        <CommandLine condition="contains">tgtdeleg</CommandLine>
        <CommandLine condition="contains">ptt</CommandLine>
        <CommandLine condition="contains">kirbi</CommandLine>
        <CommandLine condition="contains">Invoke-Kerberoast</CommandLine>
        <CommandLine condition="contains">Get-DomainSPNTicket</CommandLine>
        <CommandLine condition="contains">Request-SPNTicket</CommandLine>
        <CommandLine condition="contains">Get-Keylistkey</CommandLine>
        <CommandLine condition="contains">Get-KerberosAESKey</CommandLine>

        <!-- User/Group enumeration -->
        <CommandLine condition="contains">net user</CommandLine>
        <CommandLine condition="contains">net group</CommandLine>
        <CommandLine condition="contains">net localgroup</CommandLine>
        <CommandLine condition="contains">domain admins</CommandLine>
        <CommandLine condition="contains">enterprise admins</CommandLine>
        <CommandLine condition="contains">/domain</CommandLine>
        <!-- T1087.001 specific - Local Account Discovery -->
        <Image condition="image">query.exe</Image>
        <Image condition="image">quser.exe</Image>
        <CommandLine condition="contains">net1 user</CommandLine>
        <CommandLine condition="contains">get-localuser</CommandLine>
        <CommandLine condition="contains">wmic useraccount</CommandLine>

        <!-- LOLBins -->
        <Image condition="image">certutil.exe</Image>
        <Image condition="image">mshta.exe</Image>
        <Image condition="image">regsvr32.exe</Image>
        <Image condition="image">rundll32.exe</Image>
        <Image condition="image">bitsadmin.exe</Image>
        <Image condition="image">wscript.exe</Image>
        <Image condition="image">cscript.exe</Image>
        <Image condition="image">msbuild.exe</Image>

        <!-- Lateral Movement -->
        <Image condition="image">psexec.exe</Image>
        <Image condition="image">psexesvc.exe</Image>
        <Image condition="image">wmic.exe</Image>
        <Image condition="image">winrm.exe</Image>

        <!-- Service/Task -->
        <Image condition="image">schtasks.exe</Image>
        <Image condition="image">sc.exe</Image>

        <!-- Archive -->
        <Image condition="image">rar.exe</Image>
        <Image condition="image">7z.exe</Image>
      </ProcessCreate>
    </RuleGroup>

    <RuleGroup name="ProcessCreate_Exclude" groupRelation="or">
      <ProcessCreate onmatch="exclude">
        <!-- Splunk -->
        <Image condition="begin with">C:\Program Files\SplunkUniversalForwarder\</Image>
        <!-- AD DS processes -->
        <ParentImage condition="is">C:\Windows\System32\lsass.exe</ParentImage>
      </ProcessCreate>
    </RuleGroup>

    <!-- EVENT ID 3: NETWORK - DCSync detection -->
    <RuleGroup name="NetworkConnect" groupRelation="or">
      <NetworkConnect onmatch="include">
        <Image condition="begin with">C:\Users\</Image>
        <Image condition="begin with">C:\Windows\Temp\</Image>
        <Image condition="image">cmd.exe</Image>
        <Image condition="image">powershell.exe</Image>
        <Image condition="image">certutil.exe</Image>
        <!-- DRSUAPI port (DCSync) -->
        <DestinationPort condition="is">135</DestinationPort>
        <!-- T1021.002 - SMB/Windows Admin Shares (Lateral Movement) -->
        <DestinationPort condition="is">445</DestinationPort>
        <DestinationPort condition="is">139</DestinationPort>

        <!-- Suspicious ports -->
        <DestinationPort condition="is">4444</DestinationPort>
        <DestinationPort condition="is">5555</DestinationPort>
        <DestinationPort condition="is">31337</DestinationPort>
      </NetworkConnect>
    </RuleGroup>

    <!-- EVENT ID 11: FILE CREATE -->
    <!-- NOTE: Balanced for DC - reduced noise during patching -->
    <RuleGroup name="FileCreate" groupRelation="or">
      <FileCreate onmatch="include">
        <!-- NTDS.dit copies - CRITICAL -->
        <TargetFilename condition="contains">ntds</TargetFilename>
        <TargetFilename condition="end with">.dit</TargetFilename>
        <TargetFilename condition="contains">SYSTEM.hiv</TargetFilename>
        <TargetFilename condition="contains">SAM.hiv</TargetFilename>
        <TargetFilename condition="contains">SECURITY.hiv</TargetFilename>

        <!-- Scripts (more targeted than all .exe/.dll) -->
        <TargetFilename condition="end with">.bat</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>

        <!-- Suspicious locations only for executables -->
        <Rule groupRelation="and">
          <TargetFilename condition="end with">.exe</TargetFilename>
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="end with">.exe</TargetFilename>
          <TargetFilename condition="begin with">C:\Windows\Temp\</TargetFilename>
        </Rule>
        <Rule groupRelation="and">
          <TargetFilename condition="end with">.dll</TargetFilename>
          <TargetFilename condition="begin with">C:\Users\</TargetFilename>
        </Rule>

        <!-- Task Scheduler -->
        <TargetFilename condition="begin with">C:\Windows\Tasks\</TargetFilename>

        <!-- SYSVOL tampering -->
        <TargetFilename condition="contains">\SYSVOL\</TargetFilename>
      </FileCreate>
    </RuleGroup>

    <RuleGroup name="FileCreate_Exclude" groupRelation="or">
      <FileCreate onmatch="exclude">
        <!-- Windows Update/Patching -->
        <Image condition="is">C:\Windows\System32\TiWorker.exe</Image>
        <Image condition="begin with">C:\Windows\SoftwareDistribution\</Image>
        <Image condition="is">C:\Windows\System32\wuauclt.exe</Image>
        <!-- CBS/DISM -->
        <Image condition="is">C:\Windows\System32\Dism.exe</Image>
        <TargetFilename condition="begin with">C:\Windows\WinSxS\</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\Logs\CBS\</TargetFilename>
      </FileCreate>
    </RuleGroup>

    <!-- EVENT ID 13: REGISTRY - EXPANDED FOR DC -->
    <RuleGroup name="RegistryEvent" groupRelation="or">
      <RegistryEvent onmatch="include">
        <!-- ===== PERSISTENCE MECHANISMS ===== -->
        <!-- T1547.001 - Run Keys -->
        <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunOnceEx</TargetObject>

        <!-- T1547.004 - Winlogon -->
        <TargetObject condition="contains">CurrentVersion\Winlogon\Shell</TargetObject>
        <TargetObject condition="contains">CurrentVersion\Winlogon\Userinit</TargetObject>
        <TargetObject condition="contains">CurrentVersion\Winlogon\Notify</TargetObject>

        <!-- T1543.003 - Services -->
        <TargetObject condition="end with">\ServiceDll</TargetObject>
        <TargetObject condition="end with">\ImagePath</TargetObject>
        <TargetObject condition="end with">\FailureCommand</TargetObject>
        <TargetObject condition="contains">\Parameters\ServiceDll</TargetObject>

        <!-- T1546.015 - COM Hijacking -->
        <TargetObject condition="contains">\Software\Classes\CLSID\</TargetObject>
        <TargetObject condition="contains">\InprocServer32</TargetObject>
        <TargetObject condition="contains">\LocalServer32</TargetObject>

        <!-- T1546.010 - AppInit DLLs -->
        <TargetObject condition="contains">\Windows\CurrentVersion\Windows\AppInit_DLLs</TargetObject>
        <TargetObject condition="contains">\Windows\CurrentVersion\Windows\LoadAppInit_DLLs</TargetObject>

        <!-- T1546.012 - IFEO Debugging -->
        <TargetObject condition="contains">\Image File Execution Options\</TargetObject>

        <!-- ===== DC-SPECIFIC - CRITICAL ===== -->
        <!-- LSA protection - CRITICAL on DC -->
        <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\Lsa\</TargetObject>
        <TargetObject condition="begin with">HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders</TargetObject>
        <TargetObject condition="end with">\Security Packages</TargetObject>
        <TargetObject condition="end with">\Authentication Packages</TargetObject>
        <TargetObject condition="end with">\Notification Packages</TargetObject>

        <!-- Group Policy integrity -->
        <TargetObject condition="contains">\Group Policy\</TargetObject>
        <TargetObject condition="contains">\Policies\Microsoft\</TargetObject>

        <!-- SAM/NTDS protection -->
        <TargetObject condition="contains">\SAM\</TargetObject>
        <TargetObject condition="contains">\NTDS\</TargetObject>

        <!-- Kerberos settings -->
        <TargetObject condition="contains">\kerberos\</TargetObject>

        <!-- ===== SECURITY TAMPERING ===== -->
        <!-- Defender tampering -->
        <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows Defender\Exclusions</TargetObject>
        <TargetObject condition="end with">\DisableAntiSpyware</TargetObject>
        <TargetObject condition="end with">\DisableAntiVirus</TargetObject>
        <TargetObject condition="end with">\DisableRealtimeMonitoring</TargetObject>

        <!-- Firewall -->
        <TargetObject condition="contains">FirewallPolicy\</TargetObject>
        <TargetObject condition="end with">\EnableFirewall</TargetObject>

        <!-- Event Log tampering -->
        <TargetObject condition="contains">\EventLog\</TargetObject>
        <TargetObject condition="end with">\MaxSize</TargetObject>

        <!-- Networking -->
        <TargetObject condition="contains">\Winsock\</TargetObject>
        <TargetObject condition="contains">\Internet Settings\ProxyServer</TargetObject>

        <!-- Print Spooler (PrintNightmare) -->
        <TargetObject condition="contains">\Print\Environments\</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <!-- EVENT ID 7: IMAGE LOAD -->
    <!-- SECURITY NOTE: lsass.exe NOT excluded - we want to see DLLs loaded into LSASS on DC -->
    <RuleGroup name="ImageLoad" groupRelation="or">
      <ImageLoad onmatch="include">
        <!-- Suspicious load locations -->
        <ImageLoaded condition="begin with">C:\Windows\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Users\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\ProgramData\</ImageLoaded>

        <!-- Credential DLLs - CRITICAL on DC -->
        <ImageLoaded condition="end with">\samlib.dll</ImageLoaded>
        <ImageLoaded condition="end with">\vaultcli.dll</ImageLoaded>
        <ImageLoaded condition="end with">\comsvcs.dll</ImageLoaded>
        <ImageLoaded condition="end with">\dbghelp.dll</ImageLoaded>
        <ImageLoaded condition="end with">\dbgcore.dll</ImageLoaded>
        <ImageLoaded condition="end with">\winsqlite3.dll</ImageLoaded>

        <!-- Mimikatz indicators -->
        <ImageLoaded condition="end with">\mimilib.dll</ImageLoaded>
        <ImageLoaded condition="end with">\mimidrv.sys</ImageLoaded>

        <!-- PowerShell in non-PowerShell processes -->
        <ImageLoaded condition="end with">\System.Management.Automation.dll</ImageLoaded>

        <!-- LSASS loading from suspicious paths -->
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\System32\lsass.exe</Image>
          <ImageLoaded condition="begin with">C:\Users\</ImageLoaded>
        </Rule>
        <Rule groupRelation="and">
          <Image condition="is">C:\Windows\System32\lsass.exe</Image>
          <ImageLoaded condition="begin with">C:\Windows\Temp\</ImageLoaded>
        </Rule>
      </ImageLoad>
    </RuleGroup>

    <RuleGroup name="ImageLoad_Exclude" groupRelation="or">
      <ImageLoad onmatch="exclude">
        <!-- Only exclude high-volume legitimate loads -->
        <!-- NOTE: lsass.exe intentionally NOT excluded on DC -->
        <Image condition="is">C:\Windows\System32\svchost.exe</Image>
        <ImageLoaded condition="begin with">C:\Windows\System32\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Windows\WinSxS\</ImageLoaded>
      </ImageLoad>
    </RuleGroup>

    <!-- EVENT ID 10: PROCESS ACCESS - LSASS on DC is CRITICAL -->
    <RuleGroup name="ProcessAccess" groupRelation="or">
      <ProcessAccess onmatch="include">
        <CallTrace condition="begin with">UNKNOWN</CallTrace>
        <Rule groupRelation="and">
          <TargetImage condition="end with">lsass.exe</TargetImage>
          <GrantedAccess condition="contains any">0x40;0x1000;0x1010;0x1038;0x1410;0x1fffff</GrantedAccess>
        </Rule>
      </ProcessAccess>
    </RuleGroup>

    <!-- EVENT ID 17-18: PIPES -->
    <RuleGroup name="PipeEvent" groupRelation="or">
      <PipeEvent onmatch="include">
        <PipeName condition="begin with">\msagent_</PipeName>
        <PipeName condition="begin with">\MSSE-</PipeName>
        <PipeName condition="begin with">\postex_</PipeName>
        <PipeName condition="begin with">\meterpreter</PipeName>
        <PipeName condition="begin with">\psexec</PipeName>
        <PipeName condition="is">\PSEXESVC</PipeName>
        <!-- DRSUAPI replication pipe -->
        <PipeName condition="contains">\drsuapi</PipeName>
      </PipeEvent>
    </RuleGroup>

    <!-- EVENT ID 19-21: WMI -->
    <RuleGroup name="WmiEvent" groupRelation="or">
      <WmiEvent onmatch="include">
        <Operation condition="is">Created</Operation>
        <Operation condition="is">Modified</Operation>
      </WmiEvent>
    </RuleGroup>

    <!-- EVENT ID 8: REMOTE THREAD -->
    <RuleGroup name="CreateRemoteThread" groupRelation="or">
      <CreateRemoteThread onmatch="exclude">
        <SourceImage condition="is">C:\Windows\system32\svchost.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\csrss.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\system32\lsass.exe</SourceImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- EVENT ID 22: DNS -->
    <!-- NOTE: DC with DNS role generates massive volume -->
    <RuleGroup name="DnsQuery" groupRelation="or">
      <DnsQuery onmatch="exclude">
        <!-- DNS Server process - CRITICAL exclusion for DC -->
        <Image condition="is">C:\Windows\System32\dns.exe</Image>
        <Image condition="is">C:\Windows\System32\svchost.exe</Image>

        <!-- Reverse lookups -->
        <QueryName condition="end with">.arpa</QueryName>
        <QueryName condition="end with">.in-addr.arpa</QueryName>

        <!-- Windows Update -->
        <QueryName condition="end with">.windowsupdate.com</QueryName>
        <QueryName condition="end with">.update.microsoft.com</QueryName>

        <!-- AD/Kerberos internal -->
        <QueryName condition="begin with">_ldap.</QueryName>
        <QueryName condition="begin with">_kerberos.</QueryName>
        <QueryName condition="begin with">_gc.</QueryName>
        <QueryName condition="begin with">_msdcs.</QueryName>

        <!-- Defender -->
        <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</Image>
      </DnsQuery>
    </RuleGroup>

    <!-- EVENT ID 5: PROCESS TERMINATE -->
    <RuleGroup name="ProcessTerminate" groupRelation="or">
      <ProcessTerminate onmatch="include">
        <Image condition="end with">\MsMpEng.exe</Image>
        <Image condition="contains">CrowdStrike</Image>
        <Image condition="contains">Carbon Black</Image>
        <Image condition="contains">Cylance</Image>
        <Image condition="contains">SentinelOne</Image>
        <!-- AD critical services -->
        <Image condition="end with">\lsass.exe</Image>
        <Image condition="end with">\dns.exe</Image>
        <Image condition="end with">\ntfrs.exe</Image>
        <Image condition="end with">\dfsr.exe</Image>
      </ProcessTerminate>
    </RuleGroup>

    <!-- EVENT ID 2: FILE CREATION TIME CHANGED - Timestomping Detection -->
    <RuleGroup name="FileCreateTime" groupRelation="or">
      <FileCreateTime onmatch="include">
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="begin with">C:\Windows\</TargetFilename>
        <TargetFilename condition="contains">\SYSVOL\</TargetFilename>
        <TargetFilename condition="contains">\NTDS\</TargetFilename>
      </FileCreateTime>
    </RuleGroup>

    <!-- EVENT ID 15: FILE CREATE STREAM HASH - ADS Detection -->
    <RuleGroup name="FileCreateStreamHash" groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <TargetFilename condition="contains">:</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <RuleGroup name="FileCreateStreamHash_Exclude" groupRelation="or">
      <FileCreateStreamHash onmatch="exclude">
        <TargetFilename condition="end with">:Zone.Identifier</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 6: DRIVER LOAD
         CRITICAL for DC: Kernel-level attacks
         ============================================ -->
    <RuleGroup name="DriverLoad" groupRelation="or">
      <DriverLoad onmatch="include">
        <!-- Unsigned drivers -->
        <Signed condition="is">false</Signed>
        <!-- Drivers from suspicious locations -->
        <ImageLoaded condition="begin with">C:\Users\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Windows\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\Temp\</ImageLoaded>
        <ImageLoaded condition="begin with">C:\ProgramData\</ImageLoaded>
      </DriverLoad>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 9: RAW ACCESS READ
         CRITICAL for DC: NTDS.dit offline extraction
         ============================================ -->
    <RuleGroup name="RawAccessRead" groupRelation="or">
      <RawAccessRead onmatch="include">
        <!-- ANY raw disk access on DC is suspicious -->
        <Device condition="begin with">\Device\Harddisk</Device>
      </RawAccessRead>
    </RuleGroup>

    <RuleGroup name="RawAccessRead_Exclude" groupRelation="or">
      <RawAccessRead onmatch="exclude">
        <!-- Defender -->
        <Image condition="begin with">C:\ProgramData\Microsoft\Windows Defender\</Image>
        <!-- Backup software - CUSTOMIZE -->
        <!-- <Image condition="begin with">C:\Program Files\Veeam\</Image> -->
      </RawAccessRead>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 25: PROCESS TAMPERING
         Detects process hollowing, herpaderping
         ============================================ -->
    <RuleGroup name="ProcessTampering" groupRelation="or">
      <ProcessTampering onmatch="include">
        <!-- ALL process tampering is suspicious on DC -->
        <Type condition="is">Image is replaced</Type>
        <Type condition="is">Image is locked for access</Type>
      </ProcessTampering>
    </RuleGroup>

    <!-- ============================================
         EVENT ID 26: FILE DELETE DETECTED
         Track deletion of evidence
         ============================================ -->
    <RuleGroup name="FileDelete" groupRelation="or">
      <FileDelete onmatch="include">
        <!-- Executables deleted -->
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <!-- Log deletion -->
        <TargetFilename condition="end with">.evtx</TargetFilename>
        <TargetFilename condition="end with">.log</TargetFilename>
        <!-- NTDS related -->
        <TargetFilename condition="contains">ntds</TargetFilename>
      </FileDelete>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
